## 磁盘分区

### **1. 什么是磁盘分区？**
磁盘分区（Disk Partitioning）是指将 **物理硬盘** 划分成 **一个或多个逻辑区域（分区）**，以便操作系统可以管理和使用存储空间。分区可以存储不同的文件系统，如 **FAT16、FAT32、NTFS、EXT4** 等。

#### **1.1 分区类型**
在 **MBR（Master Boot Record）分区表** 结构中，磁盘的分区主要分为：
- **主分区（Primary Partition）**：最多支持 **4 个**，可用于安装操作系统或存储数据。
- **扩展分区（Extended Partition）**：用于存储 **逻辑分区**，但本身不能直接存储数据。
- **逻辑分区（Logical Partition）**：位于 **扩展分区内部**，可用于存储数据（类似主分区）。

> **注意**：  
> - MBR 方式 **最大支持 2TB** 的磁盘，超过 2TB 需使用 **GPT（GUID Partition Table）**。  
> - **GPT 分区** 没有限制 4 个主分区的约束，可创建 **128 个分区**。

---

### **2. FAT16 磁盘分区结构**
**FAT16（File Allocation Table 16-bit）** 是 **DOS、Windows 95/98** 时代广泛使用的文件系统，它的分区结构包括：
1. **主引导记录（MBR）**
2. **引导扇区（Boot Sector）**
3. **FAT 表（File Allocation Table）**
4. **根目录区（Root Directory）**
5. **数据区（Data Area）**

---

#### **2.1 FAT16 磁盘结构示意图**
```plaintext
+------------------------------+
| MBR                          |   512 字节
+------------------------------+
| Boot Sector                  |   512 字节
+------------------------------+
| FAT 1(File Allocation Table) |  大小不固定
+------------------------------+
| FAT 2(Backup FAT)            |  大小与 FAT 表 1 相同
+------------------------------+
| Root Directory               |  固定大小（每个条目 32 字节）
+------------------------------+
| Data Area                    |  磁盘剩余部分（存储文件数据）
+------------------------------+
```

---

### **3. FAT16 结构详细说明**
#### **3.1 主引导记录（MBR）**
- 位置：**磁盘第 0 扇区（512 字节）**
- 作用：
  - 存储 **分区表（Partition Table）**。
  - 包含 **引导代码**，用于引导操作系统。
- 结构：
  | 偏移 | 大小 | 内容 |
  |------|------|------|
  | 0x000 | 446B | 引导代码 |
  | 0x1BE | 64B  | 分区表（最多 4 个分区，每个 16B） |
  | 0x1FE | 2B   | 0x55AA（MBR 结束标志） |

---

#### **3.2 引导扇区（Boot Sector）**
- 位置：**每个 FAT16 分区的第一个扇区**
- 作用：
  - 存储 FAT16 **分区信息** 和 **引导代码**。
  - 记录 **FAT 表的位置**、**簇大小**、**磁盘格式信息** 等。
- 重要参数：
  | 偏移 | 大小 | 说明 |
  |------|------|------|
  | 0x0B | 2B   | 每个扇区的字节数（通常 512） |
  | 0x0D | 1B   | 每个簇的扇区数（常见 2、4、8） |
  | 0x0E | 2B   | 保留扇区数（包含引导扇区，一般为 1） |
  | 0x10 | 1B   | FAT 表数量（通常为 2） |
  | 0x11 | 2B   | 根目录最大条目数（通常 512） |
  | 0x13 | 2B   | 总扇区数（小于 65536 时有效） |
  | 0x16 | 2B   | 每个 FAT 表的扇区数 |
  | 0x1FE | 2B  | 0x55AA（扇区结束标志） |

---

#### **3.3 FAT 表（文件分配表）**
- 位置：**引导扇区后面**
- 作用：
  - 记录 **簇（Cluster）** 的分配情况，类似文件系统的“索引”。
  - **每个 FAT16 条目占 2 字节（16-bit），因此最多支持 65536 个簇**。
- 重要 FAT16 簇标记：
  | 值 | 说明 |
  |----|------|
  | 0x0000 | 空闲簇 |
  | 0xFFF7 | 坏簇（坏扇区） |
  | 0xFFFF | 文件结束（EOF） |
  | 0x0002~0xFFFE | 正常使用的簇 |

---

#### **3.4 根目录区（Root Directory）**
- 位置：**FAT 表之后**
- 作用：
  - 存储文件和文件夹的基本信息（文件名、扩展名、时间戳、起始簇号、大小等）。
- 目录项结构（32 字节）：
  | 偏移 | 大小 | 说明 |
  |------|------|------|
  | 0x00 | 8B   | 文件名（不含扩展名） |
  | 0x08 | 3B   | 扩展名 |
  | 0x0B | 1B   | 属性（隐藏/系统/目录等） |
  | 0x0E | 2B   | 创建时间 |
  | 0x16 | 2B   | 起始簇号 |
  | 0x1C | 4B   | 文件大小 |

> **根目录区大小固定**（通常支持 512 个文件），如果磁盘较大，会限制文件数量。

---

#### **3.5 数据区（Data Area）**
- 位置：**根目录区之后**
- 作用：
  - 存储文件和目录的实际数据。
  - 由 FAT 表管理，每个簇对应磁盘中的一个存储单元。

---

### Diskpart工具

```shell
# 创建虚拟磁盘
create vdisk file="路径" maximum=大小(MB) type=fixed
# 选择虚拟磁盘
select vdisk file="路径"
# 挂载
attach vdisk
# 创建分区
create partition primary
# 设置 LBA
set id=06
# 格式化为 FAT16
format fs=fat quick
# 卸载
detach vdisk
```

### **5. FAT16 的特点与限制**
#### **5.1 FAT16 优点**
✅ **兼容性强**：支持 DOS、Windows 95/98、Linux 等。  
✅ **结构简单**：适用于小型存储设备（如 U 盘、存储卡）。  
✅ **数据恢复相对容易**：由于 FAT 表记录了簇的分配情况，可以通过修复 FAT 表找回数据。  

#### **5.2 FAT16 缺点**
❌ **最大分区 2GB**：受 16-bit 地址限制，每个分区最大 2GB（簇大小 32KB 时）。  
❌ **簇浪费严重**：较大磁盘需要更大的簇（32KB），小文件会浪费大量存储空间。  
❌ **根目录区大小固定**：最多 512 个文件/目录，影响可存储文件数量。  

### 参考链接

[OSDEV - FAT](https://wiki.osdev.org/FAT)