## 虚拟内存

![虚拟内存](../images/虚拟内存.svg)

**虚拟内存地址**（Virtual Memory Address）是计算机系统中由操作系统和硬件（尤其是内存管理单元 MMU）结合使用的一种地址类型。它并不是直接映射到物理内存中的实际位置，而是为每个进程提供的一个“假象”内存空间。在虚拟内存系统中，程序运行时使用虚拟地址，操作系统通过内存管理机制将这些虚拟地址映射到实际的物理内存地址。

### 虚拟内存地址的基本概念

虚拟内存允许操作系统将计算机的物理内存抽象化，使得每个进程都拥有自己的独立的内存空间。每个进程会认为它独占整个计算机的内存，实际上，这些虚拟内存地址会被操作系统管理并映射到物理内存中。

### 虚拟内存的特点

1. **隔离性**：每个进程有自己的虚拟内存空间，相互之间不可访问。操作系统保证一个进程不能直接访问另一个进程的内存，防止进程间的干扰和数据泄露。
  
2. **内存扩展**：虚拟内存使得程序可以使用比实际物理内存更多的内存。当物理内存不足时，操作系统通过交换（swapping）或分页（paging）将不常用的数据暂时存储到磁盘的交换文件（swap file）或分页文件（page file）中，提供虚拟地址空间的扩展。

3. **程序透明性**：程序员编写的程序不需要关心内存的具体物理布局，只需使用虚拟地址。操作系统和硬件负责将虚拟地址转换为物理地址。

4. **高效利用内存**：虚拟内存技术让操作系统能够将内存高效地分配给不同的进程，避免了内存碎片问题，并且可以实现内存共享。

### 虚拟内存地址的结构

---

```shell
# 以32位内存地址为例

31       23       15       7        0
+--------+--------+---+----+--------+
|     Page Number     |   Offset    |
+--------+--------+---+----+--------+
                      12
```

$ PN_{max} = 2^{20} 个页 $

$ Offset_{max} = 2^{12} = 4096B = 4KB $

$ 2^{20} \times 4KB = 4GB $

---

虚拟内存地址通常由两部分组成：

- **页号（Page Number）**：虚拟地址中的高位部分，用于标识虚拟内存页。一个程序的虚拟内存被划分为多个页（Page），每个虚拟页的大小通常为 4KB（可以根据系统配置不同而有所变化）。页号用来索引页表，查找该虚拟页在物理内存中对应的页框（Page Frame）。
  
- **页内偏移（Page Offset）**：虚拟地址中的低位部分，用于标识虚拟页内的具体位置，即该页内的偏移量。页内偏移大小取决于页的大小，例如在 4KB 页面大小下，低 12 位即为页内偏移。

假设虚拟地址为 32 位，虚拟内存的总大小为 4 GB。那么，虚拟地址结构通常可以被分为以下几部分：
- **高 20 位** 用于表示虚拟页号。
- **低 12 位** 用于表示页内偏移。

### 虚拟内存的工作原理

1. **虚拟地址的访问**：
   当 CPU 执行一个程序，并试图访问某个虚拟地址时，首先会将该虚拟地址传递给 MMU（内存管理单元）。

2. **地址转换**：
   MMU 负责将虚拟地址转换为物理地址。这一过程通常使用页表来完成。页表是一个数据结构，它保存了虚拟地址到物理地址的映射关系。

   - **页表**：虚拟内存系统通常使用页表来存储虚拟页号和物理页框号的映射。通过查询页表，MMU 可以找到虚拟页号对应的物理页框号。
   - **分页机制**：将虚拟内存划分为固定大小的页（如 4KB），每个虚拟页对应物理内存中的一个页框。操作系统通过管理页表来维护这种映射关系。
   
3. **虚拟内存的转换流程**：
   - **提取页号和页内偏移**：虚拟地址被分为页号和页内偏移。页号用于查找页表，页内偏移用来定位虚拟页内的具体位置。
   - **查询页表**：MMU 根据虚拟页号查找页表，得到对应的物理页框号。
   - **计算物理地址**：将物理页框号与页内偏移结合，得到实际的物理地址。
   - **访问物理内存**：最后，CPU 使用物理地址访问实际的物理内存。

4. **虚拟内存的支持**：
   - **分页**：系统通过分页将虚拟内存划分为多个小块（页），这些页在物理内存中可能并不连续。
   - **换页机制（Page Swapping）**：如果系统内存不足，操作系统会将不常用的页面从物理内存移到硬盘的交换空间（Swap Space）中。这个过程对程序透明，程序依然可以访问它的虚拟地址。

### 虚拟内存的优点

1. **提供更大的地址空间**：通过虚拟内存，程序可以使用超过物理内存的内存空间。例如，32 位系统的虚拟地址空间为 4 GB，而物理内存可能只有 1 GB。操作系统会把不常用的数据暂时存储在磁盘中。

2. **进程隔离**：每个进程都有独立的虚拟地址空间，不会互相干扰。这种隔离有助于提高系统的稳定性和安全性。

3. **内存共享**：多个进程可以共享相同的内存区域（如共享库、共享内存区域等），而不必在每个进程中都复制相同的数据。

4. **简化程序设计**：程序员无需关心物理内存的具体布局。程序只需要使用虚拟地址，操作系统和硬件负责地址转换和内存管理。

### MMU

MMU（Memory Management Unit，内存管理单元）是一种硬件组件，用于计算机系统中管理和控制内存的使用。它的主要功能是将程序的虚拟地址映射到物理地址，并提供一些额外的内存管理特性，如内存保护、缓存控制和虚拟内存支持。

MMU的主要功能包括：

1. **地址转换**：
   - **虚拟地址到物理地址映射**：程序在运行时使用虚拟地址，MMU负责将这些虚拟地址转换为物理地址，以便 CPU 可以访问实际的内存。现代操作系统通常会使用分页（Paging）或分段（Segmentation）技术来管理虚拟地址空间和物理内存。
   
2. **内存保护**：
   - MMU可以确保不同的进程和程序访问自己分配的内存区域，防止程序间的内存访问冲突。比如，操作系统可以设置不同的访问权限（如只读、只写、可执行等），保护系统内核和用户程序的内存区域。
   
3. **虚拟内存支持**：
   - 通过虚拟内存技术，MMU使得程序能够使用比物理内存更多的内存空间。操作系统可以将一部分内存数据暂时存储在硬盘上（通过交换空间或分页文件），而MMU负责管理这些内存数据的存取。

4. **内存共享**：
   - MMU支持多个进程共享内存中的同一部分区域（如共享内存区），同时保持各自的独立性。

5. **缓存控制**：
   - MMU还可以控制数据的缓存行为，例如缓存命中、缓存失效等，这对于提高内存访问速度和优化性能至关重要。

### MMU的工作原理

- **分页机制**：现代的MMU通常使用分页机制，将虚拟内存划分为固定大小的块（页，通常是4KB），并将物理内存也划分为同样大小的块（页框）。MMU通过页表存储虚拟页与物理页框的映射关系。当CPU访问虚拟地址时，MMU查找页表并将虚拟地址转换为物理地址。

- **段机制**：与分页不同，段机制将内存划分为多个不同大小的段（如代码段、数据段、堆栈段等），每个段有不同的基地址和长度。MMU通过段表来管理虚拟地址到物理地址的映射。

### MMU的组成部分

- **页表**：记录虚拟地址和物理地址的映射关系。现代MMU通常使用多级页表来优化存储。
- **TLB（Translation Lookaside Buffer）**：为加速地址转换，MMU通常内建一个高速缓存，称为TLB，用来存储最近使用的虚拟地址和物理地址映射。
- **控制寄存器**：控制MMU的行为，比如页表基地址、访问权限、虚拟内存的启用等。