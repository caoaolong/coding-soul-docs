## 图解内存分页

![](../images/内存分页.svg)

---

### 1. **启动流程（右上部分流程图）**
- **启动过程**：
  - 系统从BIOS开始启动。
  - 加载 **MBR (Master Boot Record)**，对应 `BOOT.BIN` 文件。
  - MBR 加载 **Loader**，对应 `KERNEL.BIN` 文件。
  - Loader 进入保护模式并加载内核，内核文件为 `KERNEL32.ELF`。
- **主要功能**：
  - 初始化分页机制。
  - 设置内核映射和页表。

---

### 2. **内存布局（左侧地址区域）**
- **物理内存分布**：
  - **0x00007C00**：BIOS 数据区和中断向量表。
  - **0x00007E00**：MBR。
  - **0x00008000**：Loader（Kernelx16）。
  - **0x00010000**：保护模式内核（Kernelx86）。
  - **0x00080000**：显存区域和扩展 BIOS 数据区（EBDA）。
  - **0x00100000**：内核和用户可用内存的开始地址。
  - **0x02000000**：标记可用内存结束。

---

### 3. **分页机制（中间部分）**
- **分页初始化**：
  - 将 0x00000000 至 0x3FFFFF 的 4MB 地址空间设置为可读写（RW）。
  - 使用两级分页：4MB 大页和 4KB 小页。
- **内存段映射**：
  - **4MB 页映射**：用于初始化和简单映射。
  - **4KB 页映射**：更精细的内存管理。
  
---

### 4. **内核段分布（底部区域）**
- 内核地址空间分段：
  - **.text**：代码段，存储可执行指令（只读）。
  - **.rodata**：只读数据段，存储常量。
  - **.data**：数据段，存储全局变量。
  - **.bss**：未初始化的全局变量。
  - **Bitmap**：页面位图，用于内存分配。

---

### 5. **分页表结构（右下部分）**
- **页目录表（PDE）**：
  - 每个页目录条目（PDE）映射一个 4MB 区域。
- **页表（PTE）**：
  - 每个页表条目（PTE）映射一个 4KB 小页。
  - 页表从地址 `0x00100000` 开始。
  - 举例：`0x00100000` 页表可以映射 512 个小页，每页 4KB。
  
- **地址映射公式**：
  - 虚拟地址 = 起始地址 + Bitmap 索引。
  - 页表分为 10-bit 页目录索引、10-bit 页表索引、12-bit 偏移。

---

### 6. **页面位图机制（右下角黄框）**
- Bitmap 使用一位标识一个页面的状态（0/1）。
- 每位对应一个 4KB 页面。
- 用于快速定位和分配空闲内存页面。

---

### 总结：
这张图从启动过程到内核加载，再到分页机制和地址映射，全面描述了操作系统的内存管理和分页实现细节，重点是基于保护模式下的内存布局和页表管理机制的设计与实现。