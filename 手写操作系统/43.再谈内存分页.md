## 再谈内存分页

### 虚拟内存布局

![VM](../images/虚拟内存布局.svg)

---

对于每个应用进程来讲，它所拥有的内存空间就是如图所示的虚拟内存空间，但是它只能访问用户级别的内存区域

---

### x86架构下的内存映射

![MAPPING](../images/位图的作用.svg)

---

在 x86 架构下，二级分页（也称为二级页表）使用两级页表结构来将虚拟地址映射到物理地址。二级分页通常分为页目录项（PDE）和页表项（PTE）两部分，分别负责映射虚拟地址的不同部分。

假设你要映射 4GB 的物理内存，并且每个页的大小是 4KB（典型的 x86 页大小），那么你需要考虑如何分配页目录项（PDE）和页表项（PTE）。

### 1. 每个页表项（PTE）的大小：
在 x86 架构中，传统的分页模式下，每个 PTE 是 4 字节（32 位）。

### 2. 每个页目录项（PDE）的大小：
每个 PDE 的大小也是 4 字节。

### 3. 映射 4GB 的物理内存：
- 4GB 的内存总共对应 $\frac{4\text{GB}}{4\text{KB}} = 1,048,576$ 页（每页 4KB）。
- 一个页表（PTE）可以映射 1024 页，因为每个页表包含 1024 个 PTE，每个 PTE 映射 4KB 的内存。
  - 所以，需要 $\frac{1,048,576 \text{页}}{1024 \text{页/页表}} = 1024$ 个页表来映射 4GB 内存。
  
### 4. 页目录的作用：
页目录（PDE）指向 1024 个页表。每个页目录包含 1024 个 PDE，每个 PDE 映射一个页表。

### 5. 计算需要的空间：
- 每个页表需要 1024 个 PTE，每个 PTE 4 字节，因此每个页表需要 $1024 \times 4$ 字节 = 4KB。
- 1024 个页表需要 $1024 \times 4 \text{KB} = 4 \text{MB}$。
- 页目录包含 1024 个 PDE，每个 PDE 4 字节，因此页目录需要 $1024 \times 4$ 字节 = 4KB。

### 6. 总的空间需求：
$$总的空间需求 = 页目录空间 + 页表空间 = 4KB（页目录） + 4MB（页表） = 4MB + 4KB$$