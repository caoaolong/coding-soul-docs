## SBRK系统调用

`brk` 和 `sbrk` 是传统的 Unix 系统调用，用于管理进程的数据段（data segment）的大小。它们允许用户调整进程的 **堆（heap）** 大小，从而动态分配内存。

---

### **`sbrk` 的功能**
- **全称**：`sbrk` 表示 **set break**。
- **功能**：通过调整程序的“**break**”指针，改变堆的大小。
  - **break 指针**：指向当前数据段的末尾，表示堆的边界。
- **语法**：
  ```c
  void* sbrk(intptr_t increment);
  ```
  - **`increment`**：指定调整堆大小的字节数。
    - 正数：增加堆大小。
    - 负数：减少堆大小。
    - 0：不改变堆的大小，只返回当前 `break` 的位置。
  - **返回值**：
    - 成功：返回调用前的堆顶指针（`break`）。
    - 失败：返回 `(void *)-1`，同时设置 `errno`。

---

### 内存分配两种的情况

1. 不需要新分配页
    + 直接向上移动`eheap` 

2. 需要新分配页
    + 分配页
    + 向上移动`eheap`

![SBRK](../images/SBRK.svg)
---

### **工作机制**
1. **初始状态**：
   - 当程序启动时，堆的大小固定，由操作系统在进程的虚拟地址空间中分配。
   - `brk` 指针位于堆的末尾，表示堆的当前边界。

2. **堆大小调整**：
   - 调用 `sbrk` 时，内核通过调整 `brk` 指针的值来改变堆的大小。
   - 如果 `brk` 指针超出分配的虚拟地址空间范围，系统会通过分配新的页（通常是 4KB 页）来扩展堆。

3. **内存管理**：
   - 应用程序通过 `malloc` 等库函数间接使用 `sbrk`，`malloc` 会调用 `sbrk` 增加堆的大小。

---

### **与 `brk` 的关系**
- `brk` 和 `sbrk` 都用于调整堆的大小，但它们的使用方式不同：
  - **`brk`**：直接设置堆顶位置。
    ```c
    int brk(void *addr);
    ```
    - 参数 `addr` 表示新的 `break` 位置。
  - **`sbrk`**：通过相对偏移调整堆大小。