### 图解TSS任务切换

![TSS - 任务切换](../images/图解TSS任务切换.svg)

这是一张关于任务状态段（TSS）切换过程的图解，分为多个部分来描述任务初始化和任务切换的过程。以下是图中内容的详细描述：

---

### **顶部部分：任务初始化**
1. **左侧：主任务（main_task）的初始化**
   - TSS描述符 `main_task->selector` 的值为 `0x0020`。
   - 主任务的 TSS 段结构中保存了以下关键寄存器：
     - `esp`, `eip`, `eflags` 等指向任务执行时的状态。
     - 段寄存器（如 `cs`, `ds`, `es` 等）设置为内核段选择子。

2. **右侧：子任务（child_task）的初始化**
   - TSS描述符 `child_task->selector` 的值为 `0x0018`。
   - 子任务的 TSS 段结构中保存了与主任务类似的寄存器状态，但与主任务有所区别，例如 `eip` 指向子任务代码入口。

---

### **中间部分：任务切换机制**
1. **左侧黄色注释框**
   - 描述了 CPU 在任务切换时利用 Task Gate 或 TSS 机制的方式。使用 `TR`（任务寄存器）指向当前任务的 TSS。

2. **右侧流程**
   - 任务切换过程分为两步：
     1. 使用 `write_tr(main_task->selector)` 设置任务寄存器（TR）。
     2. 使用 `far_jump(to->selector, 0)` 执行远跳转，完成任务切换。

3. **切换路径**
   - 主任务切换到子任务（`main_task -> child_task`）的流程：
     - 加载 `child_task` 的 TSS。
     - 通过 `Task Gate` 或直接切换到新的 TSS，完成上下文恢复。

---

### **底部部分：子任务返回主任务**
1. **子任务切换回主任务的流程**
   - 流程类似于主任务切换到子任务，重新加载 `main_task` 的 TSS。
   - `TR` 的值从 `0x0018` 切换回 `0x0020`。

---

### **总结**
- 图示清晰地描述了通过 TSS 实现的任务切换机制。
- 强调了 `TR` 和 TSS 在任务状态保存与恢复中的关键作用。
- 各任务的 TSS 数据结构包含任务的寄存器状态，有助于实现任务间的上下文切换。