## 线程睡眠

![线程睡眠](../images/线程调度-线程睡眠.svg)

根据上传的图片内容，以下是 `SLEEP` 函数的实现原理描述：

---

### **1. 数据结构说明**
- **`task_queue`**：维护所有任务的三个子列表：
  - **`ready_list`**：存放当前处于就绪状态的任务。
  - **`sleep_list`**：存放当前处于睡眠状态的任务。
  - **`task_list`**：包含所有已注册任务的信息。
- **`default_task`**：系统中的默认任务，通常用于占用 CPU 空闲时间。
- **`running_task`**：当前正在运行的任务（通过指针指向）。

---

### **2. 调用 SLEEP 的处理流程**
1. **任务从就绪列表移除**：
   - 当前运行的任务（`running_task`）调用 `SLEEP` 后，系统会将该任务从 `ready_list` 中移除。
   - 任务被插入到 `sleep_list` 中，同时记录剩余的睡眠时间（`ticks`）。

2. **切换默认任务或其他就绪任务**：
   - 如果 `ready_list` 中有其他任务，调度器会从 `ready_list` 中选取下一个任务运行。
   - 如果没有其他任务，`running_task` 会被设置为 `default_task`，让 CPU 进入空闲状态。

---

### **3. 等待 Timer 中断**
- **Timer 中断触发机制**：
  - 定时器定期触发中断，操作系统在每次中断中执行如下步骤：
    - 遍历 `sleep_list` 中的所有任务，减少每个任务的 `ticks`（剩余睡眠时间）。
    - 如果某任务的 `ticks` 减少到 0，表示其睡眠时间已到。

---

### **4. 唤醒任务**
- **任务从睡眠列表移到就绪列表**：
  - 当 Timer 中断发现某任务的睡眠时间已结束：
    - 将该任务从 `sleep_list` 移除。
    - 将该任务插入 `ready_list` 的队尾。
  - 调度器根据调度策略决定是否切换到新唤醒的任务。

---

### **5. 总体流程总结**
- `SLEEP` 函数的实现核心在于将当前任务从 `ready_list` 移动到 `sleep_list`，并依赖定时器中断进行时间管理。
- 当定时器中断触发，睡眠时间到期时，任务从 `sleep_list` 返回到 `ready_list`，等待再次调度。

---

这种基于列表的任务管理结构实现了任务的高效切换与睡眠管理，避免了睡眠任务占用 CPU 时间，同时使调度更加灵活和可控。